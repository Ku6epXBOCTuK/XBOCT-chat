# ADR 001: Архитектура мультиплатформенного чат-агрегатора

**Статус:** Принято (Decided)  
**Контекст:** Разработка MVP приложения для стримеров на Tauri (Rust) + SvelteKit. Агрегация чатов (Twitch, YT и др.) и вывод в OBS через открытый локальный сервер.

---

## 1. Бэкенд и Модульность (Rust)

### Система коннекторов (Traits)

Каждая платформа (Twitch, YouTube и др.) реализует единый интерфейс `ChatPlatform`.

- **Изоляция:** Каждая платформа работает в своей async-задаче. Падение одного коннектора не влияет на другие.
- **OAuth 2.0:** Реализуется через временный локальный сервер для перехвата токенов из браузера.

### Нормализация данных (Unified Schema)

Все входящие данные приводятся к структуре `UnifiedChatMessage`:

- `id`: UUID.
- `author`: Имя отправителя.
- `content`: Массив токенов (текст + ссылки на эмоуты). Парсинг смайлов (7TV, BTTV) происходит на стороне Rust.
- `metadata`: Флаги модератора, саба, значки.

---

## 2. Сетевое взаимодействие (OBS Overlay)

### HTTP Сервер (Axum/Actix)

- **Binding:** Настраиваемый хост. По умолчанию `127.0.0.1`, с возможностью смены на `0.0.0.0` для прямого доступа через Wi-Fi (Dual PC Setup).
- **Backlog:** Сервер хранит в памяти последние 20–50 сообщений и мгновенно отдает их при подключении нового клиента, чтобы оверлей не был пустым.

### Безопасность и Доступ

- **Open Access:** Доступ к WebSocket открытый (без токенов), так как оверлей транслирует публичные данные чата.
- **Read-only WS:** Сокет в OBS-виджете работает только на прием данных от сервера. Любые входящие пакеты закрывают соединение.

---

## 3. Система кастомных тем (Theming)

Для обеспечения **максимальной свободы** (изменение верстки сообщений) реализован механизм **Runtime HTML Templates**:

1. **Внешние ресурсы:** Темы лежат в `AppData/themes/` и раздаются сервером как статика.
2. **Template Injection:**
   - Оверлей (Svelte) загружает `layout.html` темы через `fetch`.
   - Используется стандартный тег `<template>` с плейсхолдерами (например, `{{author}}`, `{{content}}`).
3. **Runtime Rendering:**
   - Svelte управляет списком сообщений и лимитами.
   - Отрисовка конкретных элементов происходит через `{@html}` после подстановки данных в шаблон.
4. **XSS Protection:** Обязательное экранирование (sanitization) текста сообщений перед вставкой в шаблон для защиты оверлея стримера.

---

## 4. Расширяемость (Plugins)

- **Rust Middlewares:** Плагины-обработчики могут менять или фильтровать сообщения до их отправки в оверлей.
- **Frontend Plugins:** Возможность подключения сторонних JS/CSS файлов внутри папки темы для кастомных анимаций и эффектов.

---

## 5. Стабильность

- **Reconnection:** Автоматический retry для коннекторов платформ (Rust) и логика переподключения сокета в коде оверлея (JS).
